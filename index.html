<!DOCTYPE html>
<html lang="ru">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#222222">

  <meta name="keywords" content="HTML, CSS, JavaScript">
  <meta name="description" content="Часы, погода, датчик температуры, CO2 на esp32 и esp8266 c использованием матрицы MAX7219">

  <link rel="shortcut icon" href="data:image/png;base64,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fQzblxnAf7mdZyzy2LdDN8QNDoAkgQMgSeAASBI4AJIEDoAkgQMgSeAASBI4AJIEDoAkgQMgSeAASBI4AJIEDoAkgQMgSeAASBI4AJIEDoAkgQMgSeAASNrmPK778zVrjct1xjG97e+z+DPOX0+zgD+6nWcs8ti3QzfEDQ6AJIEDIEngAEgSOACSBA6AJIEDIEngAEgSOACSBA6AJIEDIEngAEgSOACSBA6AJIEDIEngAEgSOACSBA6AJIEDIEngAEja5jyu+/M1a43LdQbAx3I7z1jksW+HbogbHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABkCRwACQJHABJAgdAksABEPTLL/8BOGmlYIitzrQAAAAASUVORK5CYII="> 
	<title>WiFi-CLOCK firmware installer</title>
  <script type="module" src="./js/install-button.js"></script>
	<style>
		body {
			font-family: Verdana, Helvetica, sans-serif;
			text-align: center;
			background-color: #222;
			margin: 0;
      color: #fff;
		}
    
    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' fill='white'><polygon points='0,0 100,0 50,50'/></svg>") no-repeat;
      background-size: 12px;
      background-position: 97% 17px;
      padding-left: 12px !important;
      background-repeat: no-repeat;
      outline: none;
    }
    select:-moz-focusring {
      transition-duration: 0s;
      color: transparent;
      text-shadow: 0 0 0 #fff;
    }
    option {
      background-color: var(--c-3);
      color: var(--c-f);
    }
    
    .btn {
      outline: none;
      cursor: pointer;
      padding: 8px;
      margin: 10px;
      width: 230px;
      font-family: Verdana, Helvetica, sans-serif;
      font-size: 19px;
      background-color: #333;
      color: white;
      border: 0px solid white;
      border-radius: 25px;
    }
    
    img {
      width: 400px;
      max-width: 40%;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      margin: 3vh 0 5px 0;
      animation: fi 1s;
      min-width: 380px;
    }
    
    @keyframes fi {
    from { opacity: 0; }
    to   { opacity: 1; }
    }
    
    .main {
			position: absolute;
			left: 0;
			right: 0;
			top: 140px;
      animation: fi 1.5s .7s both;
    }
    
    a {
      color: #fff;
      cursor: pointer;
      text-decoration: underline;
    }
    
    ol {
      margin: auto;
      text-align: left;
      display: inline-block;
    }
    
    li::marker {
      text-decoration: bold;
      color: #09f;
    }
    
    li {
      margin: 5px;
    }
    
    .container {
      width: 80%;
      max-width: 510px;
      margin: auto;
			margin-top: 30px;
      border-radius: 5px;
      box-sizing: border-box;
      background-color: #222;
      overflow: hidden;
      min-width: 340px;
    }
    
    .inst-button {
      padding: 5px 0;
    }

    @media (prefers-color-scheme: dark) {
      ewt-install-dialog {
        /*--mdc-theme-primary: #ffa000; /*buttons*/
        --mdc-theme-surface: #333;
        --mdc-dialog-heading-ink-color: #fff;
        --mdc-dialog-content-ink-color: #ddd;
        --mdc-text-field-fill-color: #ddd;
      }
    }

    h2 {
      padding-inline: 10px;
    }
		
		.otherInfo{
			padding: 20px 15px;
			margin-top: 100px;
		}
		

		/*@font-face {
			font-family: "exo2";
			src: url(exo2.woff2) format("woff2");
			font-style: normal;
		}*/


		#dclock {
			animation: fi 1.3s .5s both;
			/*font-family: "exo2";*/
			color: rgb(65 200 252 / 0%);
			position: absolute;
			z-index: 1;
			overflow: show;
			margin: auto;
			top: 30px;
			left: 0;
			right: 0;
			font-family: monospace;
			font-size: 10vh;
			/*-webkit-text-stroke: 3px rgb(210, 65, 36);*/
			text-shadow: 0 0 4px #09f, 0 0 18px #09f, 0 0 18px #09f, 0 0 18px #09f;
		}
	</style>
</head>
<body onload="checkSupported()">

<div id="dclock"></div>

<div class="main">
	<h2>Добро пожаловать в веб-установщик!</h2>

	<div id="flasher">

		<ol>
			<li>Подключите ESP к USB-порту. Установщик настроен на "<span id="verstr"></span>".</li>
			<li id="coms">Нажмите «Установить» и выберите правильный COM-порт. <a onclick="showSerialHelp()">Устройство не найдено?</a></li>
			<li>Установите часы и подключите их менее чем за 3 минуты!</li>
		</ol>

		<div class="container inst-button">
			<esp-web-install-button id="inst" manifest="" install-supported="">
				<button class="btn" slot="activate">Установить</button>
			</esp-web-install-button><br>

			<div id="mySelect"></div>
			
			<!--
			<div id="eth" style="display: none;">
				<input type="checkbox" id="ethernet" name="ethernet" onchange="setManifest()">
				<label for="ethernet">На моей плате есть Ethernet</label><br>
			</div>
			-->
		</div>

	</div>

	<div class="otherInfo">
		<a href="https://github.com/WonderCRM/wondercrm.github.io/raw/main/Инструкция.pdf" target="_blank">Инструкция</a><br>
		<a href="https://t.me/s/CRMdevelop" target="_blank">Telegram</a>
		<span> | </span>
		<a href="https://cloud.mail.ru/public/5eHE/dCHUyqrr1/WiFi-CLOCK" target="_blank">Mail Cloud</a>
	</div>

</div>

<script>

console.log("Powered by ESP Web Tools for project WiFi-CLOCK (https://t.me/s/CRMdevelop)");
	
function clock() {
  var now = new Date();
  var secs = ('0' + now.getSeconds()).slice(-2);
  var mins = ('0' + now.getMinutes()).slice(-2);
  var hr = now.getHours();
	var dd = (secs % 2 == 0 ? ":" : " ");
  var Time = hr + dd + mins + dd + secs;
  document.getElementById("dclock").innerHTML = Time;
	setTimeout(()=> requestAnimationFrame(clock), 1000);
}
requestAnimationFrame(clock);


	
function setManifest() {
	var sel = document.getElementById('ver');
	var opt = sel.options[sel.selectedIndex];
	var m = opt.dataset.manifest;
	var me = opt.dataset.ethernet;
	// document.getElementById('eth').style.display = me ? "block":"none";
	if (me && document.getElementById('ethernet').checked) {
		m = me;
	}
	document.getElementById('inst').setAttribute('manifest',m);
	document.getElementById('verstr').textContent = opt.text;
}
 
 
function checkSupported() {
	var userAgent = navigator.userAgent.toLowerCase();

	if (document.getElementById('inst').hasAttribute('install-unsupported')) unsupported();
	else {
		readTextFile("files.txt");
		setManifest();
	}
}


function unsupported() {
	document.getElementById('flasher').innerHTML = "Извините, ваш браузер еще не поддерживается!<br>Пожалуйста, попробуйте настольный Chrome, Edge или Chromium-Gost."
}
  
function showSerialHelp() {
	document.getElementById('coms').innerHTML = `Нажмите «Установить» и выберите правильный COM-порт.<br><br>
	Возможно, вам не хватает драйверов для вашей платы.<br>
	Вот драйверы для чипов, обычно используемых в платах ESP.:<br>
	<a href="https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers" target="_blank">CP2102 (квадратная фишка)</a><br>
	<a href="https://github.com/nodemcu/nodemcu-devkit/tree/master/Drivers" target="_blank">CH34x (прямоугольная фишка)</a><br><br>
	Убедитесь, что ваш USB-кабель поддерживает передачу данных.<br><br>
	`;
}


function readTextFile(file) {
	var rawFile = new XMLHttpRequest();
	rawFile.open("GET", file, false);
	rawFile.onreadystatechange = function() {
		if(rawFile.readyState === 4) {
			if(rawFile.status === 200 || rawFile.status == 0)	{
				var allText = rawFile.responseText;
				var lineArr = allText.split('\n');
				var select = document.createElement("SELECT");
				var optgroup = document.createElement("OPTGROUP");
				var option = document.createElement("OPTION");
				console.log(lineArr);
				for (let i = 0; i < lineArr.length; i++) {
					if (lineArr[i] == '\r' || lineArr[i] == '') continue;
					if (lineArr[i][0] == "#") {
						if(i != 0) select.appendChild(optgroup);
						optgroup = document.createElement("OPTGROUP");
						optgroup.setAttribute("label",lineArr[i].split('#')[1]);
					} else {
						option = document.createElement("OPTION");
						var d = lineArr[i].split('+');
						option.textContent = d[0];
						option.setAttribute("data-manifest", d[1]);
						option.setAttribute("data-ethernet", d[1]);
						optgroup.appendChild(option);
					}
				}
				optgroup.appendChild(option);
				select.appendChild(optgroup);

				select.setAttribute("id","ver");
				select.setAttribute("class","btn");
				select.setAttribute("onchange","setManifest()");
				select.setAttribute("style","width: 380px");

				document.getElementById("mySelect").appendChild(select);
			}
		}
	}
	rawFile.send(null);
}

</script>

</body>
</html>
